---
title: "ENVS 193DS Homework 5"
author: "Lauren Stiles"
date: 06-02-2023
format:
  html:
    toc: true
    toc-location: left
    code-fold: true
    theme: yeti
execute: 
  message: false
  warning: false 
---
# QUESTION: How do Sarracenia characteristics predict biomass?
```{r libraries}
library(tidyverse)
library(here)
library(janitor)
library(ggeffects)
library(performance)
library(naniar) # or equivalent
library(flextable) # or equivalent
library(car)
library(broom)

# would be nice to have
library(corrplot)
library(AICcmodavg)
library(GGally)
```

# 6. INTRODUCTION 
Sarracenia, or carnivorous pitcher plants, have specific anatomy that allows them to trap and digest insects (Adlassnig et al, 2011).  These digested insects are important sources of nitrogen and phosphorus for carnivorous plants (Farnsworth & Ellison, 2008). They have cone shaped leaves from which it is difficult for an organism to remove itself once it has fallen in (Adlassnig et al, 2011). One interesting fact about Sarracenia is that a specific species called Sarracenia purpurea can be used to treat type 2 diabetes and illnesses like tuberculosis, with the potential to be used as an anti-cancer treatment (Huang et al, 2022). Therefore, many may be interested in Sarracenia research for its potential for development of life-saving drugs. In order to understand the relationships that help or hinder Sarracenia growth, it makes sense to research the morphological, physiological, or taxonomic characteristics that predict its biomass. For example, such research could advance the understanding of how to harness these plants for medicinal properties. In this document, we are addressing the question: How do Sarracenia characteristics predict biomass? The null hypothesis we are testing is that none of the characteristics predict biomass. The alternative hypothesis is that at least one of the variables predicts biomass. 

Read in data: 

```{r reading-data}
plant <- read_csv(here("data", "knb-lter-hfr.109.18 (1)", "hf109-01-sarracenia.csv")) |>
         #make column names cleaner
         clean_names() |>
         select(totmass, species, feedlevel, sla, chlorophyll, amass, num_lvs, num_phylls)

```
# 7. METHODS 
a. A variety of different species of Sarracenia were used in this study. Their Amass (mass-based light-saturated photosynthetic rate of youngest leaf) and above ground size were measured before beginning treatements. Large species were fed 0-0.10 g of finely ground wasps, intermediate sized species were fed 0-0.5 g, and small species were fed 0-0.25 g. Two plants of each species were assigned to one of these feeding levels and 120 plants total were treated. Plants were fed once per week for 7 weeks (Environmental Data Initiative:  https://portal.edirepository.org/nis/metadataviewer?packageid=knb-lter-hfr.109.18) # CITE THIS 

b. We used open access data from the EDI Portal in an attempt to understand the overarching question: How do Sarracenia characteristics predict biomass? We selected the  following variables for the analysis:  chlorophyll (chlorophyll a + b content (mg/g) of youngest fully-expanded leaf produced by the plant), amass (mass-based light-saturated photosynthetic rate of youngest leaf (units: nmol CO2 • g-1 • s-1), sla (specific Leaf Area (cm2/g) of youngest fully-expanded leaf produced by the plant), num_phylls (number of phyllodes produced by each plant), num_lvs (total number of pitchers and phyllodes produced by each plant), totmass (total above- and below-ground plant biomass), species (species of pitcher plant used -- all Sarracenia), and feedlevel (grams of ground hymenoptera fed per week). We used a linear regression model to analyze the relationship between the above variables and biomass. 


c. Visualize the missing data (see figure below): We are interested in looking at how the factors in each column affect total mass of the plants, and we are not yet sure how they will do so. Therefore, we drop the NA values to get the most accurate picture of their relationships. 

```{r missing-data-visualization}
missing_dat <- gg_miss_var(plant) + 
              labs(caption = "There is missing data in 5 columns: cholorphyll, amass, sla, num_phylls, and num_lvs")
missing_dat
#lots of chlorophyll, amass, sla, num_phulls, num_lvs 
#totmass, species, feedlevel don't have missing data 
#we are interested in looking how factors affect totmass 
#we do not know how these will affect, so we will drop them 

```



Subsetting data by dropping NAs: 

```{r subset-drop-NA}
#get rid of the missing values from the above visualization 
plant_subset <- plant|> 
                drop_na(sla, chlorophyll, amass, num_lvs, num_phylls)
#103 observations compared to the original 120 

```


d. Visualization of Pearson’s correlation between variables: This plot indicates that none of the investigated variables have a notably strong relationship, since all are < |0.7|. The strongest positive relationship is between sla () and amass and the strongest negative relastionship is between num_lvs and amass. 

```{r correlation-plot}
#plot to visually represent pearson's r between different variables in the dataset 

#calculate pearson's r for numerical predictors only 
plant_cor <- plant_subset |> 
            #select only the numerical predictor variables 
             select(feedlevel:num_phylls) |> 
            #cor calculates various correlation metrics, pearsons, kendall, spearman --> we will use pearson 
             cor(method = "pearson") #output is a correlation matrix, diagonal = variables compared to themselves, above and below is correlation with another variable 


#creating a correlation plot 
cor_plot <- corrplot(plant_cor, 
        #change the shape of what is in the cells 
        method = "ellipse", #right and left pointing represents whether relationship is positive or negative
        #show coefficients and choose color for them 
        addCoef.col = "black",
        mar=c(1,1,2,1))
title(main="title", sub="Numbers in black represent the correlation between overlapping variables in each box. The ellipses pointing to the right represent a positive relationship, while those to the left represent a negative relationship. Colors represent strength of the relationship along a spectrum")

  
```

Create a plot of each variable compared against the other (does not calc correlation, just a "pairs plot")
e. Visualization of relationship between variables????
```{r pairs-plot}
#NOT SURE HOW TO DO CAPTION HERE ???

plant_subset |> 
      #select only the numerical predictor variables 
       select(species:num_phylls) |> 
       ggpairs() #lots of plots, pearson's coefficients 
#this is usually part of exploratory analysis 
#gives a sense of how the variables are related to each other 
#USE ACTIVE VOICE WHEN EXPLANING 

```

# Starting regression here 

(example writing) To determine the relationships between numerical variables in our dataset, we calculated pearson's r and visually represented correlation using a correlation plot. 

(example) To determine how species and physiological characteristics predict biomass, we fit multiple linear models. 

f. The null model establishes predicted values by chance, rather than based on the variables we are interested in. In contrast, the full model establishes predicted values based off of each of the different variables we are interested in. 
```{r null-and-full-model}
#write null model -- specify using "1" as predictor 
null <- lm(totmass ~ 1, data = plant_subset)
#specify full model with everything in it 
full <- lm(totmass ~ species + feedlevel + sla + chlorophyll + amass + num_lvs, data = plant_subset)

```

g. We visually assessed normality and homoskedasticity of residuals using diagnostic plots for the FULL MODEL: These plots indicated that the residuals are not homoskedastic, since the points are clumped together towards the beginning of the line in both the residuals vs fitted and the scale-location plot. The Normal Q-Q plot shows some deviation from the line on both ends, but there are no outliers affecting the distribution, since there are no labeled points outside of the dotted lines. We found that the residuals are neither normally distributed nor homoskedastic using the Shapiro-Wilk test (null = variable of interest (i.e. the residuals) are normally distributed) and the Breusch-Pagan test (null = variable of interest (residuals) has constant variance).
```{r full-diagnostics}
par(mfrow = c(2,2))
plot(full)
#they look normal BUT residuals clumped at the beginning and random at the end -- probs heteroskedastic
#kind of borderline...
#we can do statistical test to check normality and homoskedasticity 


```
 
```{r}
#performance package
check_normality(full) #warning -- non-normality of residuals --> this is typical for a large dataset 
#but it looks normal on the diagnostics 

check_heteroscedasticity(full) #seems like residuals are heteroskedastic, but we knew this 

#THE ASSUMPTIONS OF LINEAR REGRESSIONS ARE NOT MET 
#ONE OF THE BEST WAYS TO MAKE IT WORK IS TO TRANSFORM THE RESPONSE VARIABLE (ln, log, ect) --> idea is that the residuals will be transformed to be normal 
```
h. Since the full model did not show normally distributed and homoskedastic residuals, we tried transforming the data using log() in hope that the residuals will now meet these assumptions. 
```{r}
full_log <- lm(log(totmass) ~ species + feedlevel + sla + chlorophyll + amass + num_lvs, data = plant_subset) #hope that residuals will now be normally dist

par(mfrow = c(2,2))
plot(full_log)
check_normality(full_log)
check_heteroscedasticity(full_log)
#all interpretation will be based on transformed response, have been natural log transformed 
```
i. Model construction with visual and statistical assumption checks for three
additional models: 

```{r}
#so does this mean i try more model runs with different predictor variables ?? how does this work? 

```

